!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?module.exports=t():"function"==typeof define&&define.amd?define(t):(e="undefined"!=typeof globalThis?globalThis:e||self).Flow=t()}(this,(function(){"use strict";const e=["file-added","files-added","files-submitted"],t=["filter-file"],s=["complete","error","file-error","file-progress","file-removed","file-retry","file-success","progress","upload-start"];EventTarget.prototype._addEventListener=EventTarget.prototype.addEventListener,EventTarget.prototype._removeEventListener=EventTarget.prototype.removeEventListener;class i extends EventTarget{constructor(e={}){super(),this._events={},this._hooks={};for(let[t,s]of Object.entries(e))for(let e of s)this.on(t,e)}isHook(t){return e.includes(t)||this.isFilter(t)}isFilter(e){return t.includes(e)}isEvent(e){return!this.isHook(e)}_camelToDashCase(e){return e.replace(/[A-Z]/g,(e=>`-${e.toLowerCase()}`))}on(i,r,n){var a=this._camelToDashCase(i);return a!=i&&(console.warn(`Flow.js v3: Do not rely on camel-case (${i}) event names.`),e.concat(t,s).includes(a)&&(i=a,console.info(`Using "${a}" instead.`))),this.isEvent(i)?this.addEventListener(i,r,n):this.addHook(i,r,n)}once(e,t,s){return this.isEvent(e)?this.addEventListener(e,t,{...s,once:!0}):console.warn("once() is not implemented for hooks.")}off(e,t,s){!this.isEvent(e)&&e||this.removeEventListener(e,t,s),this.isEvent(e)&&e||this.removeHook(e,t,s)}addEventListener(e,t,s=!1){let i=t,r=()=>{this.removeEventListener(e,t,s),i.apply(this,arguments)};return s&&s.once&&(t=r),this._addEventListener(e,t,s),this._events||(this._events={},Object.defineProperty(this,"_events",{enumerable:!1})),this._events[e]||(this._events[e]=[]),this._events[e].push({listener:t,useCapture:!0===s||s.capture||!1,passive:s&&s.passive||!1,once:s&&s.once||!1,type:e}),()=>{this.removeEventListener(e,t,s)}}removeEventListener(e,t=null,s=!1){if(t&&this._removeEventListener(e,t,s),this._events&&(!e||this._events[e]))if(e&&"*"!==e){for(const[i,r]of this._events[e].entries())if((!t||r.listener==t)&&r.useCapture==s){if(this._events[e].splice(i,1),t)break;this._removeEventListener(e,r.listener,r)}0==this._events[e].length&&delete this._events[e]}else for(let e of Object.keys(this._events))this.removeEventListener(e)}async emit(e,...t){this.dispatchEvent(new CustomEvent(e,{detail:t})),"catch-all"!=e&&this.emitCatchAll(e,...t)}async emitCatchAll(e,...t){this.dispatchEvent(new CustomEvent("catch-all",{detail:[e,...t]}))}addHook(e,t,s){var i=this._hooks;i.hasOwnProperty(e)||(i[e]=[]),i[e].push(t)}hasHook(e,t){t="string"==typeof t?[t]:t||[];var s=this._hooks;for(let[e,i]of Object.entries(s))if((!(t.length>0)||t.includes(e))&&i.length>0)return!0;return!1}removeHook(e,t,s){if(e&&"*"!=e)if(t){var i=this._hooks;i.hasOwnProperty(e)&&(r=i[e],n=t,(a=r.indexOf(n))>-1&&r.splice(a,1))}else delete this._hooks[e];else this._hooks={};var r,n,a}async hook(e,...t){let s,i=this._hooks[e]||[],r=this.isFilter(e);return i.length?(s=await Promise.all(i.map((e=>e.apply(this,t)))),r?s=s.includes(!0):"file-added"===e&&s.includes(!1)&&console.warn("In Flow.js 3.x, file-added event is an action rather than a filter. Return value is ignored but removing the `file` property allows to skip an enqueued file.")):s=!!r||t[0],this.emitCatchAll(e,...t),s}}function r(e,t,s,i,r){var n="slice";e.file.slice?n="slice":e.file.mozSlice?n="mozSlice":e.file.webkitSlice&&(n="webkitSlice"),r.readFinished(e.file[n](t,s,i))}function n(e,t){return"function"==typeof e&&(t=Array.prototype.slice.call(arguments),e=e.apply(null,t.slice(1))),e}function a(e,t,s){var i;if(e)if(void 0!==e.length){for(i=0;i<e.length;i++)if(!1===t.call(s,e[i],i))return}else for(i in e)if(e.hasOwnProperty(i)&&!1===t.call(s,e[i],i))return}("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{}).evalOpts=n;class o{constructor(){this.resolved=!1,this._promise=new Promise(((e,t)=>{this.resolve=()=>(this.resolved=!0,e()),this.reject=t})),this.then=this._promise.then.bind(this._promise),this.catch=this._promise.catch.bind(this._promise),this[Symbol.toStringTag]="Promise"}}class h{constructor(e,t,s){this.flowObj=e,this.fileObj=t,this.offset=s,this.tested=!1,this.retries=0,this.pendingRetry=!1,this.preprocessState=0,this.readState=0,this.payload=null,this.readBytes=-1,this.readStreamState=new o,this.loaded=0,this.total=0,this.chunkSize=this.fileObj.chunkSize,this.startByte=this.offset*this.chunkSize,this.filename=null,this.endByte=this.computeEndByte(),this.xhr=null}computeEndByte(){var e=Math.min(this.fileObj.size,(this.offset+1)*this.chunkSize);return this.fileObj.size-e<this.chunkSize&&!this.flowObj.opts.forceChunkSize&&(e=this.fileObj.size),e}event(e,t){(t=Array.prototype.slice.call(arguments)).unshift(this),this.fileObj.chunkEvent.apply(this.fileObj,t)}progressHandler(e){e.lengthComputable&&(this.loaded=e.loaded,this.total=e.total),this.event("progress",e)}testHandler(e){var t=this.status(!0);"error"===t?(this.event(t,this.message()),this.flowObj.uploadNextChunk()):"success"===t?(this.tested=!0,this.event(t,this.message()),this.flowObj.uploadNextChunk()):this.fileObj.paused||(this.tested=!0,this.send())}doneHandler(e){var t=this.status();if("success"===t||"error"===t)delete this.data,this.event(t,this.message()),this.flowObj.uploadNextChunk();else if(!this.fileObj.paused){this.event("retry",this.message()),this.pendingRetry=!0,this.abort(),this.retries++;var s=this.flowObj.opts.chunkRetryInterval;null!==s?setTimeout((()=>this.send()),s):this.send()}}getParams(){return{flowChunkNumber:this.offset+1,flowChunkSize:this.chunkSize,flowCurrentChunkSize:this.endByte-this.startByte,flowTotalSize:this.fileObj.size,flowIdentifier:this.fileObj.uniqueIdentifier,flowFilename:this.fileObj.name,flowRelativePath:this.fileObj.relativePath,flowTotalChunks:this.fileObj.chunks.length}}getTarget(e,t){return 0==t.length?e:(e.indexOf("?")<0?e+="?":e+="&",e+t.join("&"))}test(){this.xhr=new XMLHttpRequest,this.xhr.addEventListener("load",this.testHandler.bind(this),!1),this.xhr.addEventListener("error",this.testHandler.bind(this),!1);var e=n(this.flowObj.opts.testMethod,this.fileObj,this),t=this.prepareXhrRequest(e,!0);this.xhr.send(t)}async preprocessFinished(){this.endByte=this.computeEndByte(),this.preprocessState=2,await this.send()}readFinished(e){this.readState=2,this.payload=e,this.send()}async readStreamGuard(){var e=this.fileObj.chunks.map((e=>e.readStreamState)).slice(0,this.offset);try{await Promise.all(e)}catch(t){throw console.error(`Chunk ${this.offset}: Error while waiting for ${e.length} previous chunks being read.`),t}}async readStreamChunk(){if(this.readStreamState.resolved)return this.payload&&this.pendingRetry?(console.info(`Retrying chunk ${this.offset} upload`),this.uploadStreamChunk(this.payload)):(console.warn(`Chunk ${this.offset} already read. xhr initialized = ${this.xhr?1:0}. payload size = ${this.payload?this.payload.size:null}. readState = ${this.readState}. retry = ${this.pendingRetry}`),null);this.readState=1,await this.readStreamGuard();var e,t=this.flowObj.opts.asyncReadFileFn;return e=await t(this.fileObj,this.startByte,this.endByte,this.fileObj.file.type,this),this.readStreamState.resolve(),this.readState=2,e&&(this.readBytes=e.size||0===e.size?e.size:-1),this.uploadStreamChunk(e)}async uploadStreamChunk(e){if(e&&e.size>0)return this.fileObj.chunkSize&&e.size>this.fileObj.chunkSize&&console.warn(`Chunk ${this.offset}: returned too much data. Got ${e.size}. Expected not more than ${this.flowObj.chunkSize}.`),this.payload=e,void this.xhrSend(e);if(this.offset>0){var t=this.fileObj.chunks[this.offset-1].readBytes;if(t<parseInt(this.chunkSize))return console.warn(`Chunk ${this.offset} seems superfluous. No byte read() meanwhile previous chunk was only ${t} bytes instead of ${this.chunkSize}`),this.pendingRetry=!1,this.xhr={readyState:4,status:200,abort:e=>null},void this.doneHandler(null)}console.warn(`Chunk ${this.offset}: no byte to read()`),this.pendingRetry=!1}async send(){var e=this.flowObj.opts.preprocess,t=this.flowObj.opts.readFileFn,s=this.flowObj.opts.asyncReadFileFn;if("function"==typeof e)switch(this.preprocessState){case 0:return this.preprocessState=1,void e(this);case 1:return}if(s)await this.readStreamChunk();else{switch(this.readState){case 0:return this.readState=1,void t(this.fileObj,this.startByte,this.endByte,this.fileObj.file.type,this);case 1:return}this.xhrSend(this.payload)}}xhrSend(e){if(!this.flowObj.opts.testChunks||this.tested){this.loaded=0,this.total=0,this.pendingRetry=!1,this.xhr=new XMLHttpRequest,this.xhr.upload.addEventListener("progress",this.progressHandler.bind(this),!1),this.xhr.addEventListener("load",this.doneHandler.bind(this),!1),this.xhr.addEventListener("error",this.doneHandler.bind(this),!1);var t=n(this.flowObj.opts.uploadMethod,this.fileObj,this),s=this.prepareXhrRequest(t,!1,this.flowObj.opts.method,e),i=this.flowObj.opts.changeRawDataBeforeSend;"function"==typeof i&&(s=i(this,s)),this.xhr.send(s)}else this.test()}abort(){this.xhr&&this.xhr.abort(),this.xhr=null}status(e){return 1===this.readState?"reading":1===this.preprocessState?"uploading":!this.xhr||this.pendingRetry?"pending":this.xhr.readyState<4?"uploading":this.flowObj.opts.successStatuses.indexOf(this.xhr.status)>-1?"success":this.flowObj.opts.permanentErrors.indexOf(this.xhr.status)>-1||!e&&this.retries>=this.flowObj.opts.maxChunkRetries?"error":(this.abort(),"pending")}message(){return this.xhr?this.xhr.responseText:""}progress(){if(this.pendingRetry)return 0;var e=this.status();return"success"===e||"error"===e?1:"pending"===e?0:this.total>0?this.loaded/this.total:0}sizeUploaded(){var e=this.endByte-this.startByte;return"success"!==this.status()&&(e=this.progress()*e),e}prepareXhrRequest(e,t,s,i){var r=n(this.flowObj.opts.query,this.fileObj,this,t);r=Object.assign({},r||{},this.getParams());var o=n(this.flowObj.opts.target,this.fileObj,this,t),h=null;if("GET"===e||"octet"===s){var l=[];a(r,(function(e,t){l.push([encodeURIComponent(t),encodeURIComponent(e)].join("="))})),o=this.getTarget(o,l),h=i||null}else h=new FormData,a(r,(function(e,t){h.append(t,e)})),void 0!==i&&h.append(this.flowObj.opts.fileParameterName,i,this.filename||this.fileObj.file.name);return this.xhr.open(e,o,!0),this.xhr.withCredentials=this.flowObj.opts.withCredentials,a(n(this.flowObj.opts.headers,this.fileObj,this,t),(function(e,t){this.xhr.setRequestHeader(t,e)}),this),h}}class l{constructor(e,t,s){this.flowObj=e,this.file=t,this.name=t.fileName||t.name,this.size=t.size,this.relativePath=t.relativePath||t.webkitRelativePath||this.name,this.uniqueIdentifier=void 0===s?e.generateUniqueIdentifier(t):s,this.chunkSize=0,this.chunks=[],this.paused=!1,this.error=!1,this.averageSpeed=0,this.currentSpeed=0,this._lastProgressCallback=Date.now(),this._prevUploadedSize=0,this._prevProgress=0}measureSpeed(){var e=Date.now()-this._lastProgressCallback;if(e){var t=this.flowObj.opts.speedSmoothingFactor,s=this.sizeUploaded();this.currentSpeed=Math.max((s-this._prevUploadedSize)/e*1e3,0),this.averageSpeed=t*this.currentSpeed+(1-t)*this.averageSpeed,this._prevUploadedSize=s}}chunkEvent(e,t,s){switch(t){case"progress":if(Date.now()-this._lastProgressCallback<this.flowObj.opts.progressCallbacksInterval)break;this.measureSpeed(),this.flowObj.emit("file-progress",this,e),this.flowObj.emit("progress"),this._lastProgressCallback=Date.now();break;case"error":this.error=!0,this.abort(!0),this.flowObj.emit("file-error",this,s,e),this.flowObj.emit("error",s,this,e);break;case"success":if(this.error)return;this.measureSpeed(),this.flowObj.emit("file-progress",this,e),this.flowObj.emit("progress"),this._lastProgressCallback=Date.now(),this.isComplete()&&(this.currentSpeed=0,this.averageSpeed=0,this.flowObj.emit("file-success",this,s,e));break;case"retry":this.flowObj.emit("file-retry",this,e)}}pause(){this.paused=!0,this.abort()}resume(){this.paused=!1,this.flowObj.upload()}abort(e){this.currentSpeed=0,this.averageSpeed=0,e&&(this.chunks=[]);for(let e of this.chunks)"uploading"===e.status()&&(e.abort(),e.pendingRetry=!0,this.flowObj.uploadNextChunk())}cancel(){this.flowObj.removeFile(this)}retry(){this.bootstrap("retry"),this.flowObj.upload()}bootstrap(e=null,t=this.flowObj.opts.initFileFn){"function"==typeof t&&t(this),this._bootstrap()}_bootstrap(){this.abort(!0),this.error=!1,this._prevProgress=0;var e=this.flowObj.opts.forceChunkSize?Math.ceil:Math.floor;this.chunkSize=n(this.flowObj.opts.chunkSize,this);for(var t=Math.max(e(this.size/this.chunkSize),1),s=0;s<t;s++)this.chunks.push(new h(this.flowObj,this,s))}progress(){if(this.error)return 1;if(1===this.chunks.length)return this._prevProgress=Math.max(this._prevProgress,this.chunks[0].progress()),this._prevProgress;var e=0;a(this.chunks,(function(t){e+=t.progress()*(t.endByte-t.startByte)}));var t=e/this.size;return this._prevProgress=Math.max(this._prevProgress,t>.9999?1:t),this._prevProgress}isUploading(){var e=!1;return a(this.chunks,(function(t){if("uploading"===t.status())return e=!0,!1})),e}isComplete(){var e=!1;return a(this.chunks,(function(t){var s=t.status();if("pending"===s||"uploading"===s||"reading"===s||1===t.preprocessState||1===t.readState)return e=!0,!1})),!e}sizeUploaded(){var e=0;return a(this.chunks,(function(t){e+=t.sizeUploaded()})),e}timeRemaining(){if(this.paused||this.error)return 0;var e=this.size-this.sizeUploaded();return e&&!this.averageSpeed?Number.POSITIVE_INFINITY:e||this.averageSpeed?Math.floor(e/this.averageSpeed):0}getType(){return this.file.type&&this.file.type.split("/")[1]}getExtension(){return this.name.substr(2+(~-this.name.lastIndexOf(".")>>>0)).toLowerCase()}}("undefined"!=typeof window?window:"undefined"!=typeof global?global:"undefined"!=typeof self?self:{}).FlowFile=l;class d extends l{async retry(){return await this.bootstrap("retry"),await this.flowObj.upload()}async bootstrap(e=null,t=this.flowObj.opts.initFileFn){return"function"==typeof t&&await t(this,e),this._bootstrap(),this}isReading(){for(let e of this.chunks)if("reading"===e.status())return!0;return!1}}
/**
   * @license MIT
   */class u extends i{constructor(e,t){super(t),u.version="3.0.0-alpha.0",this.supportDirectory=/Chrome/.test(window.navigator.userAgent)||/Firefox/.test(window.navigator.userAgent)||/Edge/.test(window.navigator.userAgent),this.files=[],this.defaults={chunkSize:1048576,forceChunkSize:!1,simultaneousUploads:3,singleFile:!1,fileParameterName:"file",progressCallbacksInterval:500,speedSmoothingFactor:.1,query:{},headers:{},withCredentials:!1,preprocess:null,changeRawDataBeforeSend:null,method:"multipart",testMethod:"GET",uploadMethod:"POST",prioritizeFirstAndLastChunk:!1,allowDuplicateUploads:!1,target:"/",testChunks:!0,generateUniqueIdentifier:null,maxChunkRetries:0,chunkRetryInterval:null,permanentErrors:[404,413,415,500,501],successStatuses:[200,201,202],onDropStopPropagation:!1,initFileFn:null,readFileFn:r,asyncReadFileFn:null},this.opts={},this.opts=Object.assign({},this.defaults,e||{}),this._onDropBound=null}onDrop(e){this.opts.onDropStopPropagation&&e.stopPropagation(),e.preventDefault();var t=e.dataTransfer;t.items&&t.items[0]&&t.items[0].webkitGetAsEntry?this.webkitReadDataTransfer(e):this.addFiles(t.files,e)}preventEvent(e){e.preventDefault()}webkitReadDataTransfer(e){var t=e.dataTransfer.items.length,s=()=>{0==--t&&this.addFiles(i,e)},i=[];for(let t of e.dataTransfer.items){var r=t.webkitGetAsEntry();if(!r)return void s();r.isFile?a(t.getAsFile(),r.fullPath):n(r.createReader())}function n(e){e.readEntries((i=>{if(i.length){t+=i.length;var r={};for(let e of i)e.isFile?(r[e.name]=e.fullPath,e.file((e=>a(e,r[e.name])),o)):e.isDirectory&&n(e.createReader());n(e)}else s()}),o)}function a(e,t){e.relativePath=t.substring(1),i.push(e),s()}function o(e){throw s(),e}}async generateUniqueIdentifier(e){var t=this.opts.generateUniqueIdentifier;if("function"==typeof t)return await t(e);var s=e.relativePath||e.webkitRelativePath||e.fileName||e.name;return e.size+"-"+s.replace(/[^0-9a-zA-Z_-]/gim,"")}async uploadNextChunk(e){var t=!1;if(this.opts.prioritizeFirstAndLastChunk){for(let e of this.files){if(!e.paused&&e.chunks.length&&"pending"===e.chunks[0].status()){await e.chunks[0].send(),t=!0;break}if(!e.paused&&e.chunks.length>1&&"pending"===e.chunks[e.chunks.length-1].status()){await e.chunks[e.chunks.length-1].send(),t=!0;break}}if(t)return t}e:for(let e of this.files)if(!e.paused)for(let s of e.chunks)if("pending"===s.status()){await s.send(),t=!0;break e}if(t)return!0;var s=!1;for(let e of this.files)if(!e.isComplete()){s=!0;break}return s||e||this.emit("complete"),!1}async assignBrowse(e,t,s,i){e instanceof Element&&(e=[e]),a(e,(function(e){var r;"INPUT"===e.tagName&&"file"===e.type?r=e:((r=document.createElement("input")).setAttribute("type","file"),Object.assign(r.style,{visibility:"hidden",position:"absolute",width:"1px",height:"1px"}),e.appendChild(r),e.addEventListener("click",(function(){r.click()}),!1)),this.opts.singleFile||s||r.setAttribute("multiple","multiple"),t&&r.setAttribute("webkitdirectory","webkitdirectory"),a(i,(function(e,t){r.setAttribute(t,e)})),r.addEventListener("change",(async e=>{e.target.value&&(await this.addFiles(e.target.files,e),e.target.value="")}),!1)}),this)}assignDrop(e){void 0===e.length&&(e=[e]),this._onDropBound=this.onDrop.bind(this);for(let t of e)t.addEventListener("dragover",this.preventEvent,!1),t.addEventListener("dragenter",this.preventEvent,!1),t.addEventListener("drop",this._onDropBound,!1)}unAssignDrop(e){void 0===e.length&&(e=[e]);for(let t of e)t.removeEventListener("dragover",this.preventEvent,!1),t.removeEventListener("dragenter",this.preventEvent,!1),t.removeEventListener("drop",this._onDropBound,!1)}isUploading(){var e=!1;return a(this.files,(function(t){if(t.isUploading())return e=!0,!1})),e}_shouldUploadNext(){var e=0,t=!0,s=this.opts.simultaneousUploads;return a(this.files,(function(i){a(i.chunks,(function(i){if("uploading"===i.status()&&++e>=s)return t=!1,!1}))})),t&&e}async upload(){var e=this._shouldUploadNext();if(!1!==e){this.emit("upload-start");for(var t=!1,s=1;s<=this.opts.simultaneousUploads-e;s++)t=await this.uploadNextChunk(!0)||t;t||this.emit("complete")}}resume(){a(this.files,(function(e){e.isComplete()||e.resume()}))}pause(){a(this.files,(function(e){e.pause()}))}cancel(){for(var e=this.files.length-1;e>=0;e--)this.files[e].cancel()}progress(){var e=0,t=0;return a(this.files,(function(s){e+=s.progress()*s.size,t+=s.size})),t>0?e/t:0}async addFile(e,...t){return(await this.addFiles([e],...t))[0]}async addFiles(e,t=null,s=this.opts.initFileFn){let i=[];const r=window.navigator.msPointerEnabled;for(let a of e){if(r&&0===a.size||a.size%4096==0&&("."===a.name||"."===a.fileName))continue;var n=await this.generateUniqueIdentifier(a);if(!this.opts.allowDuplicateUploads&&this.getFromUniqueIdentifier(n))continue;if(!await this.hook("filter-file",a,t))continue;let e=new d(this,a,n).bootstrap(t,s);i.push(e)}let a=await Promise.all(i);for(let e of a)await this.hook("file-added",e,t);a=a.filter((e=>e&&e.file)),await this.hook("files-added",a,t),a=a.filter((e=>e&&e.file));for(let e of a)this.opts.singleFile&&this.files.length>0&&this.removeFile(this.files[0]),this.files.push(e);return await this.hook("files-submitted",this.files,t),a}removeFile(e){for(var t=this.files.length-1;t>=0;t--)if(this.files[t]===e){this.files.splice(t,1),e.abort(),this.emit("file-removed",e);break}}getFromUniqueIdentifier(e){var t=!1;return a(this.files,(function(s){s.uniqueIdentifier===e&&(t=s)})),t}getSize(){var e=0;return a(this.files,(function(t){e+=t.size})),e}sizeUploaded(){var e=0;return a(this.files,(function(t){e+=t.sizeUploaded()})),e}timeRemaining(){var e=0,t=0;return a(this.files,(function(s){s.paused||s.error||(e+=s.size-s.sizeUploaded(),t+=s.averageSpeed)})),e&&!t?Number.POSITIVE_INFINITY:e||t?Math.floor(e/t):0}}return u}));
//# sourceMappingURL=flow.min.js.map
